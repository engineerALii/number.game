<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØ© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        //  âš™ï¸ Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù„Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©)
        // =================================================================
        
        // Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø§Ù†ÙŠ ÙÙŠ Google Firebase:
        // 1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ https://console.firebase.google.com
        // 2. Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ (Create Project).
        // 3. Ø£Ø¶Ù ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ (Web App) ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† (firebaseConfig).
        // 4. Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ "Authentication" (ÙˆØ¶Ø¹ Anonymous) Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Build.
        // 5. Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ "Firestore Database" (ÙˆØ¶Ø¹ Test Mode) Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Build.
        // 6. Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† Firebase.

        const manualConfig = {
            apiKey: "Ø¶Ø¹_API_KEY_Ø§Ù„Ø®Ø§Øµ_Ø¨Ùƒ_Ù‡Ù†Ø§", // Ù…Ø«Ø§Ù„: AIzaSyB...
            authDomain: "example-project.firebaseapp.com",
            projectId: "example-project",
            storageBucket: "example-project.appspot.com",
            messagingSenderId: "00000000000",
            appId: "1:00000000000:web:00000000000000"
        };

        // Ø§Ù„ÙƒÙˆØ¯ ÙŠÙ‚ÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ)
        let firebaseConfig;
        let appId;

        try {
            if (typeof __firebase_config !== 'undefined') {
                // Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                // Ø§Ø³ØªØ¶Ø§ÙØ© Ø®Ø§Ø±Ø¬ÙŠØ© (GitHub Pages ÙˆØºÙŠØ±Ù‡Ø§)
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
                // Ù†Ù‚ÙˆÙ… Ø¨ÙØ­Øµ Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ØºÙŠØ± Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (manualConfig.apiKey.includes("Ø¶Ø¹_API_KEY") || manualConfig.projectId === "example-project") {
                    throw new Error("Missing_Config");
                }
                firebaseConfig = manualConfig;
                appId = manualConfig.projectId || 'default-app-id';
            }
        } catch (e) {
            console.error("Config Error:", e);
            // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¯Ø§Ù„Ø© initApp
        }

        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let app, auth, db;
        let currentUser = null;
        let currentRoomId = null;
        let currentPlayerName = "";
        let roomUnsubscribe = null;
        let audioContext = null;

        // --- Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        const screens = {
            login: document.getElementById('login-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };
        
        const btnCreate = document.getElementById('btn-create');
        const btnJoin = document.getElementById('btn-join');
        const configErrorMsg = document.getElementById('config-error-msg');

        // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ ---
        async function initApp() {
            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
            if(btnCreate) btnCreate.addEventListener('click', createRoom);
            if(btnJoin) btnJoin.addEventListener('click', joinRoom);

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase. ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¥Ø¶Ø§ÙØ© manualConfig.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        showScreen('login');
                        enableButtons();
                        if(configErrorMsg) configErrorMsg.classList.add('hidden');
                    }
                });

                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (configErrorMsg) {
                    configErrorMsg.classList.remove('hidden');
                    configErrorMsg.innerHTML = `
                        <p class="font-bold">ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:</p>
                        <p>Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ø§ ØªØ¹Ù…Ù„ Ù„Ø£Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…ÙÙ‚ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</p>
                        <p class="text-xs mt-2">ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ (Lines 30-38) ÙˆÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase Console ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± <code>manualConfig</code>.</p>
                        <p class="text-xs mt-1 text-yellow-300">ØªØ£ÙƒØ¯ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ù† ØªÙØ¹ÙŠÙ„ Authentication (Anonymous) Ùˆ Firestore ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Firebase.</p>
                    `;
                }

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙˆØ¶Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
                if(btnCreate) {
                    btnCreate.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
                    btnCreate.classList.add('bg-red-600', 'hover:bg-red-700');
                    btnCreate.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                }
                if(btnJoin) {
                    btnJoin.innerText = "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯";
                    btnJoin.classList.add('bg-red-600', 'hover:bg-red-700');
                    btnJoin.classList.remove('bg-slate-600', 'hover:bg-slate-500');
                }
            }
        }

        function enableButtons() {
            if (btnCreate) {
                btnCreate.disabled = false;
                btnCreate.innerText = "Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©";
                btnCreate.innerHTML = '<i class="fas fa-plus-circle ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©';
                btnCreate.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            if (btnJoin) {
                btnJoin.disabled = false;
                btnJoin.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…";
                btnJoin.innerHTML = '<i class="fas fa-sign-in-alt ml-2"></i>Ø§Ù†Ø¶Ù…Ø§Ù…';
                btnJoin.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ---
        function showScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØª (Web Audio API) ---
        function playSound(type) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);

            const now = audioContext.currentTime;
            
            if (type === 'flip') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'correct') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, now); // A4
                osc.frequency.setValueAtTime(554, now + 0.1); // C#5
                osc.frequency.setValueAtTime(659, now + 0.2); // E5
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'win') {
                // Ù†ØºÙ…Ø© ÙÙˆØ² Ø¨Ø³ÙŠØ·Ø©
                osc.type = 'square';
                osc.frequency.setValueAtTime(523, now);
                osc.frequency.setValueAtTime(659, now + 0.2);
                osc.frequency.setValueAtTime(784, now + 0.4);
                osc.frequency.setValueAtTime(1046, now + 0.6);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(now);
                osc.stop(now + 1.5);
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

        async function createRoom() {
            if (!currentUser) return;

            const nameInput = document.getElementById('player-name').value.trim();
            const roomInput = document.getElementById('room-code').value.trim();

            if (!nameInput || !roomInput) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©");
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Validation)
            if (!/^[a-zA-Z0-9_-]{1,20}$/.test(roomInput)) {
                alert("ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©) ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 20 Ø­Ø±ÙØ§Ù‹.");
                return;
            }

            btnCreate.disabled = true;
            btnCreate.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...";

            try {
                currentPlayerName = nameInput;
                currentRoomId = roomInput;
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ù€ 6 Ø£Ø¬Ø²Ø§Ø¡
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);

                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©
                // Ø®Ù„Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 10
                const cards = Array.from({length: 10}, (_, i) => i + 1).sort(() => Math.random() - 0.5);

                const initialData = {
                    roomId: currentRoomId,
                    status: 'waiting', // waiting, playing, won
                    players: [{
                        uid: currentUser.uid,
                        name: currentPlayerName,
                        score: 0,
                        isHost: true
                    }],
                    cards: cards, // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                    revealedMap: {}, // Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙƒØ´ÙˆÙØ© (index -> boolean)
                    nextNumber: 1, // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„ØªØ§Ù„ÙŠ
                    currentTurnIndex: 0,
                    winner: null,
                    lastAction: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©',
                    chat: []
                };

                await setDoc(roomRef, initialData);
                subscribeToRoom();
            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: " + err.message);
                btnCreate.disabled = false;
                btnCreate.innerText = "Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©";
            }
        }

        async function joinRoom() {
            if (!currentUser) return;

            const nameInput = document.getElementById('player-name').value.trim();
            const roomInput = document.getElementById('room-code').value.trim();

            if (!nameInput || !roomInput) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©");
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Validation)
            if (!/^[a-zA-Z0-9_-]{1,20}$/.test(roomInput)) {
                alert("ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©) ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 20 Ø­Ø±ÙØ§Ù‹.");
                return;
            }

            btnJoin.disabled = true;
            btnJoin.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...";

            try {
                currentPlayerName = nameInput;
                currentRoomId = roomInput;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);
                const roomSnap = await getDoc(roomRef);

                if (!roomSnap.exists()) {
                    alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                    btnJoin.disabled = false;
                    btnJoin.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…";
                    return;
                }

                const roomData = roomSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                const playerExists = roomData.players.some(p => p.uid === currentUser.uid);
                
                if (!playerExists) {
                    const newPlayer = {
                        uid: currentUser.uid,
                        name: currentPlayerName,
                        score: 0,
                        isHost: false
                    };
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
                    const updatedPlayers = [...roomData.players, newPlayer];
                    await updateDoc(roomRef, { players: updatedPlayers });
                }

                subscribeToRoom();
            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: " + err.message);
                btnJoin.disabled = false;
                btnJoin.innerText = "Ø§Ù†Ø¶Ù…Ø§Ù…";
            }
        }

        function subscribeToRoom() {
            if (roomUnsubscribe) roomUnsubscribe();

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);
            
            roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderGame(data);
                    
                    if (data.status === 'waiting') {
                        showScreen('lobby');
                        updateLobbyUI(data);
                    } else {
                        showScreen('game');
                    }
                }
            }, (error) => {
                console.error("Error watching room:", error);
            });
        }

        // Ø¬Ø¹Ù„ Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ù„ÙˆØ¨ÙŠ
        window.startGame = async () => {
             const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);
             const cards = Array.from({length: 10}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
             
             await updateDoc(roomRef, {
                 status: 'playing',
                 cards: cards,
                 revealedMap: {},
                 nextNumber: 1,
                 currentTurnIndex: 0,
                 winner: null,
                 lastAction: 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø¬Ø¯ Ø§Ù„Ø±Ù‚Ù… 1'
             });
        };
        
        window.resetGame = async () => {
             window.startGame();
        };

        // --- ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---

        function updateLobbyUI(data) {
            const list = document.getElementById('lobby-players-list');
            list.innerHTML = '';
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.className = "flex items-center justify-between bg-slate-700 p-3 rounded-lg mb-2";
                li.innerHTML = `
                    <span class="text-white font-bold"><i class="fas fa-user ml-2"></i>${p.name}</span>
                    ${p.isHost ? '<span class="text-yellow-400 text-xs bg-yellow-900 px-2 py-1 rounded">Ù…Ø¶ÙŠÙ</span>' : ''}
                `;
                list.appendChild(li);
            });

            const isHost = data.players.find(p => p.uid === currentUser.uid)?.isHost;
            const startBtn = document.getElementById('start-game-btn');
            if (isHost) {
                startBtn.classList.remove('hidden');
            } else {
                startBtn.classList.add('hidden');
                document.getElementById('lobby-status').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...";
            }
        }

        function renderGame(data) {
            document.getElementById('room-id-display').innerText = `ØºØ±ÙØ©: ${data.roomId}`;
            const currentPlayer = data.players[data.currentTurnIndex];
            const isMyTurn = currentPlayer?.uid === currentUser.uid;
            
            const turnIndicator = document.getElementById('turn-indicator');
            const turnText = document.getElementById('turn-text');
            
            if (data.winner) {
                turnIndicator.className = "mb-6 p-4 rounded-xl bg-green-600 text-center shadow-lg transform scale-105 transition-all";
                turnText.innerHTML = `<i class="fas fa-trophy text-yellow-300 text-2xl mb-1 block"></i> Ø§Ù„ÙØ§Ø¦Ø²: ${data.winner}`;
                if (data.status !== 'won') playSound('win'); 
            } else {
                turnText.innerHTML = isMyTurn ? 
                    `<span class="text-green-300 font-bold">Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!</span> Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ù‚Ù… ${data.nextNumber}` : 
                    `Ø¯ÙˆØ±: <span class="font-bold text-yellow-300">${currentPlayer?.name}</span> (ÙŠØ¨Ø­Ø« Ø¹Ù† ${data.nextNumber})`;
                
                turnIndicator.className = isMyTurn ? 
                    "mb-6 p-4 rounded-xl bg-indigo-600 border-2 border-green-400 text-center shadow-lg transform scale-105 transition-all" : 
                    "mb-6 p-4 rounded-xl bg-slate-700 text-center shadow-md transition-all";
            }
            
            if (data.status === 'won') {
                 document.getElementById('reset-game-area').classList.remove('hidden');
            } else {
                 document.getElementById('reset-game-area').classList.add('hidden');
            }

            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';

            data.cards.forEach((cardValue, index) => {
                const isRevealed = data.revealedMap[index] === true;
                const cardEl = document.createElement('div');
                cardEl.className = `relative w-full h-24 sm:h-32 cursor-pointer perspective-1000 group`;
                
                const inner = document.createElement('div');
                inner.className = `relative w-full h-full duration-500 transform-style-3d transition-transform ${isRevealed ? 'rotate-y-180' : ''}`;
                
                const front = document.createElement('div');
                front.className = "absolute w-full h-full backface-hidden bg-slate-600 rounded-xl shadow-lg border-b-4 border-slate-800 flex items-center justify-center hover:bg-slate-500 transition-colors";
                front.innerHTML = `<i class="fas fa-question text-3xl text-slate-400"></i>`;
                
                const back = document.createElement('div');
                back.className = "absolute w-full h-full backface-hidden bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg border-b-4 border-indigo-800 flex items-center justify-center rotate-y-180";
                back.innerHTML = `<span class="text-4xl font-bold text-white drop-shadow-md">${cardValue}</span>`;
                
                inner.appendChild(front);
                inner.appendChild(back);
                cardEl.appendChild(inner);

                cardEl.onclick = () => handleCardClick(index, cardValue, isRevealed, isMyTurn, data);

                grid.appendChild(cardEl);
            });

            renderChat(data.chat);
        }

        async function handleCardClick(index, value, isRevealed, isMyTurn, data) {
            if (!isMyTurn || isRevealed || data.status === 'won') return;

            playSound('flip');
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);
            
            let updates = {};
            let nextNum = data.nextNumber;
            let nextTurn = data.currentTurnIndex;
            let status = data.status;
            let winner = data.winner;
            let revealed = { ...data.revealedMap };
            let actionMsg = "";

            if (value === nextNum) {
                playSound('correct');
                revealed[index] = true;
                nextNum++;
                actionMsg = `${currentUser.displayName || currentPlayerName} ÙˆØ¬Ø¯ Ø§Ù„Ø±Ù‚Ù… ${value}!`;
                
                if (nextNum > 10) {
                    status = 'won';
                    winner = currentPlayerName;
                    playSound('win');
                    actionMsg = `ğŸ‰ ${currentPlayerName} ÙØ§Ø² Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©!`;
                }
            } else {
                playSound('wrong');
                revealed = {}; 
                nextNum = 1; 
                nextTurn = (data.currentTurnIndex + 1) % data.players.length;
                actionMsg = `âŒ ${currentPlayerName} Ø£Ø®Ø·Ø£ (Ø§Ø®ØªØ§Ø± ${value})! ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª.`;
            }

            updates = {
                revealedMap: revealed,
                nextNumber: nextNum,
                currentTurnIndex: nextTurn,
                status: status,
                winner: winner,
                lastAction: actionMsg
            };

            await updateDoc(roomRef, updates);
        }

        window.sendChat = async () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', `room_${currentRoomId}`);
            const newMsg = {
                sender: currentPlayerName,
                text: msg,
                time: Date.now()
            };

            await updateDoc(roomRef, {
                chat: arrayUnion(newMsg)
            });
            input.value = '';
        };

        function renderChat(chatData) {
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '';
            if(!chatData) return;

            chatData.forEach(msg => {
                const isMe = msg.sender === currentPlayerName;
                const div = document.createElement('div');
                div.className = `mb-2 flex ${isMe ? 'justify-end' : 'justify-start'}`;
                div.innerHTML = `
                    <div class="${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-gray-200'} px-3 py-2 rounded-lg max-w-[80%] text-sm shadow">
                        <div class="text-xs opacity-75 mb-1 font-bold">${msg.sender}</div>
                        ${msg.text}
                    </div>
                `;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        initApp();
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen" class="flex-grow flex items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <div class="absolute top-10 left-10 text-9xl animate-bounce">?</div>
            <div class="absolute bottom-20 right-20 text-9xl animate-pulse">1</div>
            <div class="absolute top-1/2 left-1/2 text-9xl animate-spin">5</div>
        </div>

        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 z-10">
            <h1 class="text-3xl font-bold text-center mb-2 text-indigo-400">Memory Sequence</h1>
            <p class="text-slate-400 text-center mb-8">Ø±ØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ ØªØ°ÙƒØ± Ø§Ù„Ø£Ù…Ø§ÙƒÙ†ØŒ Ø§Ù‡Ø²Ù… Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ!</p>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="config-error-msg" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-3 rounded mb-4 text-sm text-center">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-300">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
                    <input type="text" id="player-name" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-300">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</label>
                    <input type="text" id="room-code" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Ù…Ø«Ø§Ù„: 1234">
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="btn-create" disabled class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all transform hover:scale-105 shadow-lg shadow-indigo-500/30 opacity-50 cursor-not-allowed">
                        <i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
                    </button>
                    <button id="btn-join" disabled class="bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold transition-all transform hover:scale-105 opacity-50 cursor-not-allowed">
                         <i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª -->
    <div id="lobby-screen" class="hidden flex-grow flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-700">
            <h2 class="text-2xl font-bold mb-4 text-center border-b border-slate-700 pb-4">ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
            <div id="lobby-status" class="text-center text-slate-400 mb-4 animate-pulse">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</div>
            <ul id="lobby-players-list" class="mb-8 max-h-60 overflow-y-auto"></ul>
            <button id="start-game-btn" onclick="startGame()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-lg shadow-lg shadow-green-500/30 transition-all hidden">
                Ø§Ø¨Ù€Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ù€Ø© Ø§Ù„Ø¢Ù†!
            </button>
        </div>
    </div>

    <div id="game-screen" class="hidden flex-grow flex flex-col md:flex-row h-screen">
        <div class="flex-grow p-4 md:p-8 flex flex-col items-center justify-center bg-slate-900 overflow-y-auto">
            <div class="w-full max-w-2xl mb-4 flex justify-between items-center text-sm text-slate-400">
                <span id="room-id-display"></span>
                <button onclick="location.reload()" class="hover:text-red-400"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
            </div>
            <div id="turn-indicator" class="w-full max-w-2xl">
                <h2 id="turn-text" class="text-xl md:text-2xl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            </div>
            <div id="reset-game-area" class="hidden mb-4 w-full max-w-2xl text-center">
                <button onclick="resetGame()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-full font-bold shadow-lg animate-bounce">
                    <i class="fas fa-redo ml-2"></i> Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                </button>
            </div>
            <div id="game-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 sm:gap-4 w-full max-w-2xl"></div>
        </div>

        <div class="w-full md:w-80 bg-slate-800 border-t md:border-t-0 md:border-r border-slate-700 flex flex-col h-1/3 md:h-full shadow-2xl z-20">
            <div class="p-3 bg-slate-900 border-b border-slate-700 font-bold flex items-center">
                <i class="fas fa-comments ml-2 text-indigo-400"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
            </div>
            <div id="chat-messages" class="flex-grow p-3 overflow-y-auto space-y-2 bg-slate-800/50"></div>
            <div class="p-3 bg-slate-900 border-t border-slate-700">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" 
                           class="flex-grow bg-slate-800 border border-slate-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-indigo-500"
                           placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                           onkeypress="if(event.key === 'Enter') sendChat()">
                    <button onclick="sendChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>
                <div class="flex gap-2 mt-2 justify-center text-lg">
                    <span class="cursor-pointer hover:scale-125 transition-transform" onclick="document.getElementById('chat-input').value += 'ğŸ˜‚'">ğŸ˜‚</span>
                    <span class="cursor-pointer hover:scale-125 transition-transform" onclick="document.getElementById('chat-input').value += 'ğŸ˜¡'">ğŸ˜¡</span>
                    <span class="cursor-pointer hover:scale-125 transition-transform" onclick="document.getElementById('chat-input').value += 'ğŸ‘'">ğŸ‘</span>
                    <span class="cursor-pointer hover:scale-125 transition-transform" onclick="document.getElementById('chat-input').value += 'ğŸ¤”'">ğŸ¤”</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
